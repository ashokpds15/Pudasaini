name: MeroShare IPO Automation

on:
  schedule:
    - cron: '15 3 * * *'  # 9:00 AM NPT daily
  
  workflow_dispatch:
    inputs:
      user_number:
        description: 'Run for specific user (1-9) or all'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - 1
          - 2
          - 3
          - 4
          - 5
          - 6
          - 7
          - 8
          - 9

jobs:
  automate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm ci
          npx playwright install chromium
      
      - name: Determine users to run
        id: users
        run: |
          if [[ "${{ github.event.inputs.user_number }}" == "all" ]]; then
            echo "users=1 2 3 4 5 6 7 8 9" >> $GITHUB_OUTPUT
          else
            echo "users=${{ github.event.inputs.user_number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Run automation for each user
        run: |
          for user in ${{ steps.users.outputs.users }}; do
            echo "Processing User $user"
            
            export MEROSHARE_USERNAME="${{ secrets[format('MEROSHARE_USERNAME_{0}', user)] }}"
            export MEROSHARE_PASSWORD="${{ secrets[format('MEROSHARE_PASSWORD_{0}', user)] }}"
            export MEROSHARE_DP_NP="${{ secrets[format('MEROSHARE_DP_NP_{0}', user)] }}"
            export MEROSHARE_BANK="${{ secrets[format('MEROSHARE_BANK_{0}', user)] }}"
            export MEROSHARE_P_ACCOUNT_NO="${{ secrets[format('MEROSHARE_P_ACCOUNT_NO_{0}', user)] }}"
            export MEROSHARE_KITTA_N0="${{ secrets[format('MEROSHARE_KITTA_N0_{0}', user)] }}"
            export MEROSHARE_CRN_NO="${{ secrets[format('MEROSHARE_CRN_NO_{0}', user)] }}"
            export MEROSHARE_TXN_PIN="${{ secrets[format('MEROSHARE_TXN_PIN_{0}', user)] }}"
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
            export USER_NUMBER="$user"
            
            # Run the automation script
            npm run automate || echo "User $user failed, continuing..."
            
            # Add delay between users to avoid rate limiting
            if [ "$user" != "${{ steps.users.outputs.users##* }}" ]; then
              sleep 10
            fi
          done
      
      - name: Send completion notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="MeroShare automation completed for users: ${{ steps.users.outputs.users }}"
